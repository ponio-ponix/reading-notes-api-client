# ノート一覧取得（検索＋ページネーション対応）

本ドキュメントは、**構造化引用検索** の中核となるエンドポイント  
`GET /api/books/:book_id/notes_search` の仕様だけを切り出して定義する。

- Base URL（開発）: `http://localhost:3000`
- Resource: Book に紐づく Note
- 認証: なし（ローカル開発用）

---

## 1. Endpoint 概要

### 1.1 エンドポイント

**GET /api/books/:book_id/notes_search**

### 1.2 用途

- 指定した Book に紐づくノート一覧を返す
- 以下の条件で検索・絞り込み・ページングを行う
  - キーワード検索（`q`）
  - ページ範囲指定（`page_from` / `page_to`）
  - ページング（`page` / `limit`）

このエンドポイントが「構造化引用検索」機能の土台に

---

## 2. パラメータ仕様

### 2.1 パスパラメータ

| name      | type    | 必須 | 説明                    |
|-----------|---------|------|-------------------------|
| `book_id` | integer | YES  | 対象となる Book の ID   |

---

### 2.2 クエリパラメータ

| name        | type    | 必須 | デフォルト | 説明                                                                 |
|-------------|---------|------|------------|----------------------------------------------------------------------|
| `q`         | string  | 任意 | `nil`      | `quote` / `memo` に対する部分一致キーワード                         |
| `page_from` | integer | 任意 | `nil`      | ページ下限（例: `10` → `page >= 10`）                                |
| `page_to`   | integer | 任意 | `nil`      | ページ上限（例: `20` → `page <= 20`）                                |
| `page`      | integer | 任意 | `1`        | 何ページ目か（1 始まり、`page >= 1`）                                |
| `limit`     | integer | 任意 | `50`       | 1ページあたり件数（上限 `200`。超えたら `200` にクランプ）         |

---

## 3. パラメータのバリデーションルール

このエンドポイントでは、**入力がおかしい場合は 400 Bad Request を返す**。

### 3.1 `page`

- 未指定 or 空文字 → `1` とみなす
- 数値に変換できない → **400 Bad Request**
- `page < 1` → `1` に正規化（エラーにしない）

### 3.2 `limit`

- 未指定 or 空文字 → `50` とみなす
- 数値に変換できない → **400 Bad Request**
- `limit < 1` → `50` に正規化（エラーにしない）
- `limit > 200` → `200` にクランプ（エラーにしない）

### 3.3 `page_from` / `page_to`

- 未指定 → 無視
- いずれかが数値に変換できない → **400 Bad Request**
- 両方指定されていて `page_from > page_to` → **400 Bad Request**

> 400 のレスポンス形式は `api_overview.md` の共通エラー仕様に従う。

---

## 4. 検索条件の適用順序（Contract）

本エンドポイントにおける検索条件は、  
以下の順序で **AND 結合** により適用される。

### 4.1 必須条件

- `book_id = :book_id`

Rails 的には：

```rb
scope = Note.where(book_id: book.id)
```


## 4.2 キーワード検索（任意）

`q` パラメータが指定された場合、`quote` / `memo` に対してキーワード検索を適用する。

### 4.2.1 クエリ文字列の正規化ルール

`q` パラメータは以下の正規化を行う。

1. **前後の空白を削除（trim処理）**
   - 例: `"  愛  "` → `"愛"`
   - 例: `"ラーメン  おすすめ"` → `"ラーメン  おすすめ"` （内部の空白は保持）

2. **trim後に空文字になる場合の扱い**
   - `q=""` または `q="   "` （空白のみ）の場合、trim後に空文字となる
   - この場合、**`q` 未指定扱いとする**（キーワード検索フィルタを適用しない）
   - つまり、一覧取得の挙動になる
   - ※ 400 Bad Request は返さない（未指定扱いで統一）

### 4.2.2 空白区切り AND 検索

trim後の `q` に空白が含まれる場合、空白区切りでトークン化し、**AND検索**を行う。

**トークン化のルール**:
- 連続する空白は1つの区切りとして扱う
- 例: `"ラーメン  おすすめ"` → `["ラーメン", "おすすめ"]` （2トークン）
- 例: `"愛"` → `["愛"]` （1トークン）

**検索条件の構築**:
- 各トークンは `quote` / `memo` に対して部分一致検索（ILIKE相当、大文字小文字無視）
- トークン同士は **AND結合**
  - つまり、**全トークンがヒットする note のみ返す**

**SQL イメージ（擬似コード）**:
```sql
-- q="ラーメン おすすめ" の場合
WHERE book_id = :book_id
  AND (
    (quote ILIKE '%ラーメン%' OR memo ILIKE '%ラーメン%')
    AND
    (quote ILIKE '%おすすめ%' OR memo ILIKE '%おすすめ%')
  )
```

**具体例**:

| `q` の値 | トークン化 | 検索条件 |
|---------|-----------|---------|
| `"愛"` | `["愛"]` | `(quote ILIKE '%愛%' OR memo ILIKE '%愛%')` |
| `"ラーメン おすすめ"` | `["ラーメン", "おすすめ"]` | `(quote ILIKE '%ラーメン%' OR memo ILIKE '%ラーメン%') AND (quote ILIKE '%おすすめ%' OR memo ILIKE '%おすすめ%')` |
| `"  愛  "` | `["愛"]` | `(quote ILIKE '%愛%' OR memo ILIKE '%愛%')` （trim後） |
| `""` or `"   "` | （未指定扱い） | キーワード検索なし（一覧取得） |

**注意**:
- 1トークンの場合、従来の単純検索と同じ挙動になる
- トークン内に空白は存在しない（split済み）
- 大文字・小文字は区別しない（ILIKE相当）

### 4.2.3 memo が NULL の場合の検索挙動

`memo` が NULL の Note は、**memo 条件では一致しない**（quote 側の一致のみが評価対象）。

**例**: q="愛" のとき
- quote="愛について", memo=NULL → ヒット（quote一致）
- quote="人生", memo=NULL → ヒットしない（quote不一致）

※ memo ILIKE ... は memo=NULL の場合 true/false ではなく UNKNOWN になるため。

---

## 4.3 ページ範囲フィルタ（任意）

ページ番号を用いた範囲指定。  
指定されている項目のみ適用する。

- `page_from` のみ指定 → `page >= page_from`
- `page_to` のみ指定 → `page <= page_to`
- `page_from` と `page_to` の両方指定 → `page BETWEEN page_from AND page_to`

※ `page_from` と `page_to` の両方が指定され、`page_from > page_to` の場合は  
**400 Bad Request** とする（パラメータエラー）。

---

## 4.4 ソート順序（Contract）

検索結果の順序は常に **`created_at DESC`（新しい順）** とする。

```rb
scope = scope.order(created_at: :desc)

```


---

## 4.5 ページング（page / limit）


ページング処理は以下の契約に従う。

page

- 未指定 → 1
- 数値でない → 400
- page < 1 → 1 に正規化

limit

- 未指定 → 50
- 数値でない → 400
- limit < 1 → 50 に正規化
- limit > 200 → 200 にクランプ

### 4.5.2 offset の計算式

```rb
offset = (page - 1) * limit
```

### 4.5.3 total_count の定義

total_count は「検索条件をすべて適用した後の総件数」。

```rb
book_id=1 のノート 200 件
キーワード q="愛" を適用 → 37 件
ページ範囲 page_from=10 を適用 → 12 件
limit=5 のとき
  total_count = 12
  total_pages = ceil(12 / 5) = 3

```

## 5. レスポンス仕様

---

## 5.1 成功時（200 OK）

```json
{
  "notes": [
    {
      "id": 5,
      "book_id": 1,
      "page": 10,
      "quote": "人間は耐えることができるのだ。",
      "memo": "テスト用",
      "created_at": "2025-12-05T02:52:03.377Z"
    }
  ],
  "meta": {
    "total_count": 5,
    "page": 1,
    "limit": 20,
    "total_pages": 1
  }
}
```

### 5.1.1 `meta` オブジェクト仕様

検索結果に付随する `meta` の構造は以下のとおり。

| key          | 型  | 説明 |
|--------------|-----|------|
| `total_count` | int | 条件にマッチしたノートの総件数 |
| `page`        | int | 現在のページ番号 |
| `limit`       | int | 1ページあたりの最大件数 |
| `total_pages` | int | `ceil(total_count / limit)` の結果 |