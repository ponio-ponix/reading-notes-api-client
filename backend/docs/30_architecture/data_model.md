# Data Model (MVP Version)

本アプリの目的は「引用＋ページ情報を爆速でインボックス化し、あとで整理可能にする」ことである。  
そのため、データモデルは極力シンプルに保つ。

---

## 1. ER 図（MVP）

Book (1) —— (N) Note

---

## 2. Book モデル

### 必要理由
- 複数冊の書籍を扱う前提のため
- Note をグルーピングする最小単位として必須

### バリデーション（暫定）
- title: presence: true  
- author: 任意

### 拡張余地
- note_count のキャッシュカラム（MVP では不要）
- last_noted_at（Bulk Create 時に更新できる設計も可能）

---

## 3. Note モデル

### 目的
引用メモの最小単位。  
UI とトランザクション境界の中心となるモデル。

### カラム仕様（MVP）
| カラム | 型 | null | 目的 |
|-------|----|------|------|
| book_id | integer | not null | 親BookへのFK |
| page | integer | null allowed | ページ番号（不明時はnull） |
| quote | text | not null | 引用文 |
| memo | text | null allowed | 補足メモ |

---

## 4. バリデーション方針（MVP）

### quote
- 必須  
- 最大文字数：**当面は無制限**  
（後から 500〜2000 文字上限も検討可能）

### page
- null 許容
- 値がある場合は: `>= 1`

### memo
- 任意
- 最大文字数上限は未設定（必要なら入れる）

---

## 5. 重複の扱い（MVP）

### 同じ page + quote が複数存在するのを許容する  
理由：
- 読書中の入力で「重複してしまうこと」は自然にありうる  
- ユニーク制約は UX を阻害する  
- 後処理（整理機能）で対応できる

---

## 6. Bulk Create を前提にしたモデル設計上の注意

### 1. Note は **1件ずつ save する** 設計のままで良い
Bulk Create はトランザクション境界の話であって、  
Note モデルに特別な insert 構造を持たせる必要はない。

### 2. モデルに副作用は持たせない
- トランザクション制御は Service Layer に集約する  
- Note.save 内で複雑なロジックを発火させない

---

## 7. 将来拡張に備えた余白

以下は MVP では入れないが、データモデルが壊れないように配慮する。

- Tag テーブル（多対多）
- Section / Chapter テーブル（自動構造化）
- index (book_id, page)
- soft delete
- note_count のキャッシュ
- 同期用の revision カラム

どれも現行の Book / Note モデルを壊さずに追加可能。

---

## 結論

MVP のデータモデルは **Book と Note の2テーブルだけ**。  
不変条件とトランザクション設計をアピールするなら、  
この最小構成が “一番強く・綺麗に・破綻せず” まとまる。

