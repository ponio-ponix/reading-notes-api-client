
# 読書引用インボックス API 仕様

## 0. 設計の目的（スタックフレームのアウトプット）

- 1リクエスト = 1スタックフレーム という前提で設計している。
  - コントローラの役割は「引数（パラメータ）を受け取り、Service を呼び、戻り値を JSON に変換する」だけ。
  - セッションに状態を隠さず、必要な状態はすべて DB とリクエストパラメータで表現する。
- 複雑な検索ロジック・ページネーションは `Notes::SearchNotes` Service に集約する。
  - Controller に `if params[:q] ...` や `where` の羅列を書かない。
- この API で示したいこと：
  - スタックフレームの概念を HTTP レイヤに落とし込んだ「関数っぽい」設計ができていること。
  - rails の「太ったコントローラ」パターンを避けて、Service レイヤで責務を分離できていること。


## 1. 共通仕様

- Base URL: `/api`
- Format: JSON
- Header:
  - `Content-Type: application/json`
- エラー時:
  - `{"errors": { "field": ["message1", ...] }}`
  - ステータスコードで種類を区別（400/404/422/500）

---

## 2. Books API

### 2.1 本一覧取得

**GET /api/books**

- Request: なし
- Response 200:

```json
[
  { "id": 1, "title": "カラマーゾフの兄弟", "author": "フョードル・ドストエフスキー" },
  { "id": 2, "title": "夜と霧", "author": "ヴィクトール・E・フランクル" }
]
```

### 2.2 ノート一覧取得（検索＋ページネーション対応）

**GET /api/books/:book_id/notes**

指定した本の引用ノート一覧を取得する。

#### クエリパラメータ（すべて任意）

- `q`         : 引用またはメモに対する部分一致検索（大文字小文字を区別しない）
- `page_from` : ページ下限（整数）
- `page_to`   : ページ上限（整数）
- `page`      : 何ページ目を取得するか（1 始まり。未指定時は 1）
- `per`       : 1ページあたりの件数（1〜200。未指定時は 50）

検索条件はすべて **AND 条件** で適用される。  
必ず `book_id` でスコープされる。  
結果は **`created_at DESC`（新しい順）** で返す。

---

#### Response 200（例）

```json
{
  "notes": [
    {
      "id": 15,
      "book_id": 1,
      "page": 123,
      "quote": "…そして人間は耐えることができるのだ。",
      "memo": "フランクルの核心っぽい",
      "created_at": "2025-12-01T16:08:34Z"
    },
    {
      "id": 9,
      "book_id": 1,
      "page": 55,
      "quote": "人間は状況に対して態度を選択する自由がある。",
      "memo": null,
      "created_at": "2025-12-01T10:21:11Z"
    }
  ],
  "meta": {
    "total_count": 12,
    "total_pages": 2,
    "current_page": 1,
    "per_page": 10
  }
}
```

---

## 3. スタックフレームとこの API の紐付けを面接でどう喋るか


- 「1 HTTP リクエストを 1 スタックフレームだと見なして設計」
  - 引数 = パラメータ（`book_id`, `q`, `page`, `per`）
  - 関数本体 = `Notes::SearchNotes.call(...)`
  - 戻り値 = `notes` + `meta`
- 「Controller にロジックを溜めず、関数っぽい Service に寄せることで、
  スタックフレームの考え方（入出力の明示、責務の分離）を Rails の設計に落とし込んでいます」